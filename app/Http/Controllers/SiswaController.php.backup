<?php

namespace App\Http\Controllers;

use App\Models\Materi;
use App\Models\ModulIqra;
use App\Models\Kuis;
use App\Models\Tugas;
use App\Models\ProgressBelajar;
use App\Models\JawabanSiswa;
use App\Models\PengumpulanTugas;
use Illuminate\Http\Request;

class SiswaController extends Controller
{
    /**
     * Display student dashboard
     */
    public function dashboard()
    {
        $user = auth()->user();
        
        // Get progress statistics
        $totalMateri = Materi::count();
        $completedMateri = ProgressBelajar::where('users_user_id', $user->id)
            ->where('status_2', 'selesai')
            ->count();
        
        $overallProgress = $totalMateri > 0 ? ($completedMateri / $totalMateri) * 100 : 0;
        
        // Get modules with progress
        $modules = ModulIqra::withCount('materi')->get()->map(function($module) use ($user) {
            $materiIds = $module->materi->pluck('materi_id');
            $completed = ProgressBelajar::where('users_user_id', $user->id)
                ->whereIn('materi_id', $materiIds)
                ->where('status_2', 'selesai')
                -> count();
            
            $module->progress = $module->materi_count > 0 ? ($completed / $module->materi_count) * 100 : 0;
            return $module;
        });
        
        // Count completed modules (progress = 100%)
        $completedModules = $modules->filter(function($module) {
            return $module->progress >= 100;
        })->count();
        
        // Upcoming assignments
        $tugasMendatang = Tugas::where('deadline', '>=', now())
            ->orderBy('deadline')
            ->limit(5)
            ->get();
        
        return view('siswa.dashboard', compact('overallProgress', 'modules', 'tugasMendatang', 'completedModules'));
    }

    /**
     * Display learning materials grid
     */
    public function materi(Request $request)
    {
        $user = auth()->user();
        $query = Materi::with(['modulIqra', 'progress' => function($q) use ($user) {
            $q->where('users_user_id', $user->id);
        }]);

        if ($request->has('module') && $request->module) {
            $query->where('modul_iqra_modul_id', $request->module);
        }

        $materis = $query->orderBy('modul_iqra_modul_id')->orderBy('created_at')->get();
        $modules = ModulIqra::all();

        return view('siswa.materi.index', compact('materis', 'modules'));
    }

    /**
     * Show learning material
     */
    public function showMateri(Materi $materi)
    {
        $materi->load('modulIqra');
        
        // Get user progress for this material
        $progress = ProgressBelajar::where('materi_id', $materi->materi_id)
            ->where('users_user_id', auth()->id())
            ->first();

        return view('siswa.materi.show', compact('materi', 'progress'));
    }

    /**
     * Mark material as complete
     */
    public function completeMateri(Materi $materi)
    {
        ProgressBelajar::updateOrCreate(
            [
                'materi_id' => $materi->materi_id,
                'users_user_id' => auth()->id(),
            ],
            [
                'status_2' => 'selesai',
                'progress_value' => 100,
                'tanggal_update' => now(),
            ]
        );

        return back()->with('success', 'Materi ditandai selesai!');
    }

    /**
     * Display quizzes
     */
    public function kuis()
    {
        $kuisList = Kuis::with('materi.modulIqra')->get();
        return view('siswa.kuis.index', compact('kuisList'));
    }

    /**
     * Show quiz
     */
    public function showKuis(Kuis $kuis)
    {
        $kuis->load(['pertanyaan.opsiJawaban']);
        return view('siswa.kuis.show', compact('kuis'));
    }

    /**
     * Submit quiz answers
     */
    public function submitKuis(Request $request, Kuis $kuis)
    {
        $answers = $request->input('answers', []);
        $kuis->load(['pertanyaan.opsiJawaban']);
        
        $totalQuestions = $kuis->pertanyaan->count();
        $correctAnswers = 0;

        foreach ($answers as $pertanyaanId => $selectedOpsi) {
            $pertanyaan = $kuis->pertanyaan->find($pertanyaanId);
            if (!$pertanyaan) continue;

            $correctOpsi = $pertanyaan->opsiJawaban->where('is_correct', true)->first();
            $isCorrect = $correctOpsi && $correctOpsi->opsi_id == $selectedOpsi;
            
            if ($isCorrect) $correctAnswers++;

            JawabanSiswa::create([
                'kuis_id' => $kuis->kuis_id,
                'users_user_id' => auth()->id(),
                'pertanyaan_id' => $pertanyaanId,
                'jawaban_pilihan' => $selectedOpsi,
                'nilai' => $isCorrect ? 1 : 0,
                'waktu_dikerjakan' => now(),
            ]);
        }

        $score = $totalQuestions > 0 ? ($correctAnswers / $totalQuestions) * 100 : 0;

        return redirect()->route('siswa.kuis.results', $kuis)
            ->with('score', $score)
            ->with('correct', $correctAnswers)
            ->with('total', $totalQuestions);
    }

    /**
     * Show quiz results
     */
    public function kuisResults(Kuis $kuis)
    {
        return view('siswa.kuis.results', compact('kuis'));
    }

    /**
     * Display assignments
     */
    public function tugas()
    {
        $tugasList = Tugas::with(['pengumpulan' => function($q) {
            $q->where('users_user_id', auth()->id());
        }])->orderBy('deadline')->get();

        return view('siswa.tugas.index', compact('tugasList'));
    }

    /**
     * Show assignment detail
     */
    public function showTugas(Tugas $tugas)
    {
        $pengumpulan = PengumpulanTugas::where('tugas_id', $tugas->tugas_id)
            ->where('users_user_id', auth()->id())
            ->first();

        return view('siswa.tugas.show', compact('tugas', 'pengumpulan'));
    }

    /**
     * Submit assignment
     */
